<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestionale Turni</title>
  <meta name="description" content="Sistema di gestione turni online con calendario, riepilogo e import Excel" />
  
  <!-- CDN Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .turno-cell { min-width: 48px; text-align: center; font-size: 11px; padding: 2px; }
    .sticky { position: sticky; z-index: 10; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>

<body class="bg-gray-50">
<div id="root"></div>

<script type="text/babel">

/* =========================================================
   ‚öôÔ∏è CONFIGURAZIONE POCKETHOST
   
   üî¥ CAMBIA QUESTO URL con il tuo URL PocketHost!
   Esempio: https://gestionale-turni.pockethost.io
   
   NON mettere slash finale: ‚úÖ .io  ‚ùå .io/
========================================================= */

const PB_URL = 'https://gest-pers.pockethost.io/'  // ‚Üê CAMBIA QUI!

/* ========================================================= */

const pb = new PocketBase(PB_URL)
pb.autoCancellation(false)

/* ========================================================= */

const COLORS = {
  M: 'bg-blue-200 text-blue-800',
  P: 'bg-orange-200 text-orange-800',
  N: 'bg-purple-200 text-purple-800',
  RPD: 'bg-pink-200 text-pink-800',
  FER: 'bg-yellow-200 text-yellow-800',
  STR: 'bg-amber-200 text-amber-800'
}

const getColor = t => {
  if (!t) return 'bg-gray-100 text-gray-400'
  const u = t.toUpperCase()
  return Object.keys(COLORS).find(k => u.startsWith(k))
    ? COLORS[Object.keys(COLORS).find(k => u.startsWith(k))]
    : 'bg-gray-100 text-gray-700'
}

const MESI = ['', 'Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre']

function App() {
  const [page, setPage] = React.useState('dashboard')
  const [anno, setAnno] = React.useState(new Date().getFullYear())
  const [mese, setMese] = React.useState(new Date().getMonth()+1)
  const [loading, setLoading] = React.useState(false)
  const [msg, setMsg] = React.useState('')
  const [turniDef, setTurniDef] = React.useState({})
  const [cal, setCal] = React.useState(null)
  const [riep, setRiep] = React.useState([])
  const [excelData, setExcelData] = React.useState(null)
  const [columnMapping, setColumnMapping] = React.useState({
    matricola: '', nome: '', data: '', turno: '', attivita: '', uo: ''
  })
  const [importProgress, setImportProgress] = React.useState(null)

  const start = `${anno}-${String(mese).padStart(2,'0')}-01`
  const end = `${anno}-${String(mese).padStart(2,'0')}-31`

  /* ------------------- LOAD TURNI DEF ------------------- */
  async function loadTurniDef() {
    try {
      const records = await pb.collection('tbl_turni').getFullList({ sort: 'turno' })
      const map = {}
      records.forEach(t => map[t.turno] = t)
      setTurniDef(map)
      return map
    } catch (error) {
      console.error('Errore caricamento turni:', error)
      setMsg('‚ö†Ô∏è Assicurati che la collection "tbl_turni" esista in PocketHost')
      return {}
    }
  }

  /* ------------------- CALENDARIO ------------------- */
  async function loadCalendario() {
    setLoading(true)
    setMsg('')
    
    let defs = Object.keys(turniDef).length ? turniDef : await loadTurniDef()

    try {
      const records = await pb.collection('gt_import').getFullList({
        filter: `data >= '${start}' && data <= '${end}'`,
        sort: 'nome,data'
      })

      const g = {}
      records.forEach(t => {
        const k = t.matricola
        if (!g[k]) g[k] = { nome: t.nome, uo: t.uo, giorni: {} }
        const d = new Date(t.data).getDate()
        g[k].giorni[d] ??= []
        if (!g[k].giorni[d].some(x => x.turno===t.turno && x.attivita===t.attivita)) {
          g[k].giorni[d].push(t)
        }
      })

      setCal({ persone: g, giorni: new Date(anno,mese,0).getDate() })

      /* ------------------- RIEPILOGO ------------------- */
      const r = {}
      records.forEach(t => {
        const turnoInfo = defs[t.turno]
        if (!turnoInfo?.is_operativo) return
        r[t.matricola] ??= { nome: t.nome, uo: t.uo, min: 0, days: {} }
        r[t.matricola].min += turnoInfo.durata_min || 0
        r[t.matricola].days[t.data] = true
      })

      setRiep(Object.entries(r).map(([m,v]) => ({
        matricola: m, nome: v.nome, uo: v.uo,
        minuti: v.min, giorni: Object.keys(v.days).length
      })))

      setMsg('')
    } catch (error) {
      console.error('Errore:', error)
      setMsg('‚ùå Errore: ' + error.message)
    }

    setLoading(false)
  }

  /* ------------------- IMPORT EXCEL ------------------- */
  function handleFileUpload(e) {
    const file = e.target.files[0]
    if (!file) return

    const reader = new FileReader()
    reader.onload = (evt) => {
      try {
        const data = new Uint8Array(evt.target.result)
        const workbook = XLSX.read(data, { type: 'array' })
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]]
        const jsonData = XLSX.utils.sheet_to_json(firstSheet)
        
        setExcelData(jsonData)
        setMsg(`‚úÖ File caricato: ${jsonData.length} righe trovate`)
        
        if (jsonData.length > 0) {
          const cols = Object.keys(jsonData[0])
          const autoMap = {}
          cols.forEach(col => {
            const lower = col.toLowerCase()
            if (lower.includes('matricola') || lower.includes('codice')) autoMap.matricola = col
            if (lower.includes('nome') || lower.includes('cognome')) autoMap.nome = col
            if (lower.includes('data')) autoMap.data = col
            if (lower.includes('turno')) autoMap.turno = col
            if (lower.includes('attivita') || lower.includes('attivit√†')) autoMap.attivita = col
            if (lower.includes('uo') || lower.includes('unit√†')) autoMap.uo = col
          })
          setColumnMapping(prev => ({ ...prev, ...autoMap }))
        }
      } catch (err) {
        setMsg('‚ùå Errore lettura file: ' + err.message)
      }
    }
    reader.readAsArrayBuffer(file)
  }

  async function importData() {
    if (!excelData || !columnMapping.matricola || !columnMapping.data || !columnMapping.turno) {
      setMsg('‚ùå Seleziona almeno: Matricola, Data e Turno')
      return
    }

    setLoading(true)
    setImportProgress({ current: 0, total: excelData.length, errors: 0 })

    let successCount = 0, errorCount = 0

    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i]
      
      let dataStr = row[columnMapping.data]
      if (typeof dataStr === 'number') {
        const excelDate = new Date((dataStr - 25569) * 86400 * 1000)
        dataStr = excelDate.toISOString().split('T')[0]
      } else if (dataStr) {
        const d = new Date(dataStr)
        if (!isNaN(d)) dataStr = d.toISOString().split('T')[0]
      }

      const record = {
        matricola: String(row[columnMapping.matricola] || ''),
        nome: row[columnMapping.nome] || '',
        data: dataStr,
        turno: row[columnMapping.turno] || '',
        attivita: row[columnMapping.attivita] || '',
        uo: row[columnMapping.uo] || ''
      }

      try {
        const existing = await pb.collection('gt_import').getFullList({
          filter: `matricola = '${record.matricola}' && data = '${record.data}' && turno = '${record.turno}'`,
          $autoCancel: false
        })

        if (existing.length > 0) {
          await pb.collection('gt_import').update(existing[0].id, record)
        } else {
          await pb.collection('gt_import').create(record)
        }
        successCount++
      } catch (err) {
        console.error('Errore import riga', i, err)
        errorCount++
      }

      setImportProgress({ current: i + 1, total: excelData.length, errors: errorCount })
    }

    setMsg(`‚úÖ Import completato! Successi: ${successCount}, Errori: ${errorCount}`)
    setExcelData(null)
    setImportProgress(null)
    setLoading(false)
    loadCalendario()
  }

  /* ------------------- TEST CONNESSIONE ------------------- */
  async function testConnection() {
    try {
      setMsg('üîÑ Test connessione...')
      await pb.health.check()
      
      const collections = await pb.collections.getFullList()
      const hasGtImport = collections.some(c => c.name === 'gt_import')
      const hasTblTurni = collections.some(c => c.name === 'tbl_turni')
      
      if (!hasGtImport || !hasTblTurni) {
        setMsg(`‚ö†Ô∏è Collections mancanti! Crea: ${!hasGtImport ? 'gt_import' : ''} ${!hasTblTurni ? 'tbl_turni' : ''}`)
      } else {
        setMsg('‚úÖ PocketBase connesso! Collections trovate.')
        setTimeout(() => setMsg(''), 3000)
      }
    } catch (error) {
      setMsg(`‚ùå Connessione fallita: ${error.message}. Verifica URL PocketHost nel codice sorgente (riga 33)`)
    }
  }

  React.useEffect(() => { 
    testConnection()
    loadCalendario() 
  }, [mese, anno])

  return (
    <div className="min-h-screen">
      {/* NAVBAR */}
      <nav className="bg-white shadow-md">
        <div className="max-w-7xl mx-auto px-4 py-3">
          <div className="flex items-center justify-between flex-wrap gap-4">
            <div className="flex gap-2">
              {['dashboard','calendario','riepilogo','import'].map(p =>
                <button key={p} onClick={()=>setPage(p)}
                  className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                    page===p ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                  }`}>
                  {p.charAt(0).toUpperCase() + p.slice(1)}
                </button>
              )}
            </div>

            <div className="flex items-center gap-3">
              <label className="flex items-center gap-2">
                <span className="text-sm font-medium text-gray-700">Mese:</span>
                <select value={mese} onChange={(e) => setMese(Number(e.target.value))}
                  className="border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                  {MESI.slice(1).map((m, i) => <option key={i+1} value={i+1}>{m}</option>)}
                </select>
              </label>

              <label className="flex items-center gap-2">
                <span className="text-sm font-medium text-gray-700">Anno:</span>
                <select value={anno} onChange={(e) => setAnno(Number(e.target.value))}
                  className="border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                  {[2023,2024,2025,2026].map(a => <option key={a} value={a}>{a}</option>)}
                </select>
              </label>

              <button onClick={testConnection}
                className="px-3 py-2 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 text-sm font-medium transition-colors"
                title="Test connessione PocketHost">
                üîå Test
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* MESSAGE BAR */}
      {msg && (
        <div className={`mx-4 mt-4 p-4 rounded-lg ${
          msg.startsWith('‚ùå') || msg.startsWith('‚ö†Ô∏è')
            ? 'bg-red-50 text-red-800 border border-red-200'
            : 'bg-green-50 text-green-800 border border-green-200'
        }`}>
          {msg}
        </div>
      )}

      {/* LOADING */}
      {loading && !importProgress && (
        <div className="flex justify-center items-center p-8">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      )}

      {/* PAGES */}
      {!loading && (
        <>
          {/* DASHBOARD */}
          {page==='dashboard' && (
            <div className="p-6 max-w-7xl mx-auto">
              <h2 className="text-3xl font-bold mb-6 text-gray-800">Dashboard</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                  <div className="text-gray-500 text-sm font-medium mb-1">Periodo</div>
                  <div className="text-2xl font-bold text-gray-800">{MESI[mese]} {anno}</div>
                </div>
                <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                  <div className="text-gray-500 text-sm font-medium mb-1">Dipendenti</div>
                  <div className="text-2xl font-bold text-blue-600">{cal ? Object.keys(cal.persone).length : 0}</div>
                </div>
                <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                  <div className="text-gray-500 text-sm font-medium mb-1">Ore Totali</div>
                  <div className="text-2xl font-bold text-green-600">{(riep.reduce((acc, r) => acc + r.minuti, 0) / 60).toFixed(1)} h</div>
                </div>
              </div>

              <div className="bg-white rounded-xl shadow-md p-6">
                <h3 className="font-bold text-lg mb-4 text-gray-800">‚ÑπÔ∏è Info Sistema</h3>
                <div className="space-y-2 text-sm">
                  <p className="text-gray-600">Backend: <code className="bg-gray-100 px-2 py-1 rounded text-blue-600">{PB_URL}</code></p>
                  <p className="text-gray-600">
                    Admin: <a href={`${PB_URL}/_/`} target="_blank" rel="noopener" 
                      className="text-blue-600 hover:underline font-medium">{PB_URL}/_/</a>
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* CALENDARIO */}
          {page==='calendario' && cal && (
            <div className="p-6 overflow-x-auto">
              <h2 className="text-2xl font-bold mb-4 text-gray-800">Calendario {MESI[mese]} {anno}</h2>
              <div className="bg-white rounded-lg shadow-md overflow-hidden">
                <table className="w-full border-collapse">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="border border-gray-300 px-3 py-2 text-left font-semibold sticky left-0 bg-gray-100">Dipendente</th>
                      {Array.from({length:cal.giorni},(_,i)=><th key={i} className="border border-gray-300 px-2 py-2 text-center font-semibold min-w-[48px]">{i+1}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {Object.entries(cal.persone).map(([m,p])=>(
                      <tr key={m} className="hover:bg-gray-50">
                        <td className="border border-gray-300 px-3 py-2 sticky left-0 bg-white">
                          <div className="font-semibold text-gray-800">{p.nome}</div>
                          <div className="text-xs text-gray-500">{m} ‚Ä¢ {p.uo}</div>
                        </td>
                        {Array.from({length:cal.giorni},(_,i)=>{
                          const it=p.giorni[i+1]||[]
                          return <td key={i} className="border border-gray-300 p-1 text-center">
                            <div className="flex flex-col gap-0.5">
                              {it.map((x,j)=>
                                <div key={j} className={`rounded px-1 py-0.5 text-xs font-medium ${getColor(x.turno)}`}
                                  title={`${x.turno}${x.attivita ? ' - '+x.attivita : ''}`}>{x.turno}</div>
                              )}
                            </div>
                          </td>
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* RIEPILOGO */}
          {page==='riepilogo' && (
            <div className="p-6 max-w-7xl mx-auto">
              <h2 className="text-2xl font-bold mb-4 text-gray-800">Riepilogo Ore e Giorni</h2>
              <div className="bg-white rounded-lg shadow-md overflow-hidden">
                <table className="w-full">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="px-4 py-3 text-left font-semibold">Matricola</th>
                      <th className="px-4 py-3 text-left font-semibold">Nome</th>
                      <th className="px-4 py-3 text-left font-semibold">UO</th>
                      <th className="px-4 py-3 text-right font-semibold">Giorni</th>
                      <th className="px-4 py-3 text-right font-semibold">Ore</th>
                    </tr>
                  </thead>
                  <tbody>
                    {riep.length===0 ? (
                      <tr><td colSpan="5" className="px-4 py-8 text-center text-gray-500">Nessun dato disponibile</td></tr>
                    ) : (
                      riep.map(r=>(
                        <tr key={r.matricola} className="border-t hover:bg-gray-50">
                          <td className="px-4 py-3 font-mono text-sm">{r.matricola}</td>
                          <td className="px-4 py-3 font-medium">{r.nome}</td>
                          <td className="px-4 py-3">{r.uo}</td>
                          <td className="px-4 py-3 text-right text-blue-600 font-medium">{r.giorni}</td>
                          <td className="px-4 py-3 text-right font-bold text-green-600">{(r.minuti/60).toFixed(1)}</td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* IMPORT */}
          {page==='import' && (
            <div className="p-6 max-w-4xl mx-auto">
              <h2 className="text-2xl font-bold mb-6 text-gray-800">Importa Turni da Excel</h2>

              <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 className="font-bold mb-3">1. Carica file Excel</h3>
                <input type="file" accept=".xlsx,.xls" onChange={handleFileUpload}
                  className="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0
                    file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100 cursor-pointer" />
              </div>

              {excelData && (
                <>
                  <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 className="font-bold mb-4">2. Mappa le colonne</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {Object.keys(columnMapping).map(field => (
                        <div key={field}>
                          <label className="block text-sm font-medium mb-2 capitalize">
                            {field} {['matricola','data','turno'].includes(field) && <span className="text-red-500">*</span>}
                          </label>
                          <select value={columnMapping[field]}
                            onChange={(e) => setColumnMapping({...columnMapping, [field]: e.target.value})}
                            className="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Seleziona colonna --</option>
                            {Object.keys(excelData[0]).map(col => <option key={col} value={col}>{col}</option>)}
                          </select>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 className="font-bold mb-4">3. Anteprima (prime 5 righe)</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-gray-100">
                          <tr>{Object.keys(excelData[0]).map(col => <th key={col} className="px-3 py-2 text-left font-semibold">{col}</th>)}</tr>
                        </thead>
                        <tbody>
                          {excelData.slice(0,5).map((row,i)=>(
                            <tr key={i} className="border-t">
                              {Object.values(row).map((val,j)=><td key={j} className="px-3 py-2">{String(val)}</td>)}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div className="flex gap-3">
                    <button onClick={importData} disabled={loading}
                      className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 disabled:bg-gray-400">
                      {loading ? 'Importazione...' : `Importa ${excelData.length} record`}
                    </button>
                    <button onClick={() => {setExcelData(null); setMsg('')}}
                      className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600">
                      Annulla
                    </button>
                  </div>
                </>
              )}

              {importProgress && (
                <div className="mt-6 bg-white rounded-lg shadow-md p-6">
                  <div className="flex justify-between mb-2 text-sm">
                    <span>Importazione in corso...</span>
                    <span>{importProgress.current} / {importProgress.total} {importProgress.errors > 0 && `(${importProgress.errors} errori)`}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-4">
                    <div className="bg-blue-600 h-4 rounded-full transition-all"
                      style={{width: `${(importProgress.current/importProgress.total)*100}%`}} />
                  </div>
                </div>
              )}
            </div>
          )}
        </>
      )}
    </div>
  )
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>)
</script>
</body>
</html>
